<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>raceland: Describing local pattern of racial landscape using SocScape grids • raceland</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="raceland: Describing local pattern of racial landscape using SocScape grids">
<meta property="og:description" content="raceland">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">raceland</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/raceland-intro1.html">raceland: R package for a pattern-based, zoneless method for analysis and visualization of racial topography</a>
    </li>
    <li>
      <a href="../articles/raceland-intro2.html">raceland: Describing local racial patterns of racial landscapes at different spatial scales</a>
    </li>
    <li>
      <a href="../articles/raceland-intro3.html">raceland: Describing local pattern of racial landscape using SocScape grids</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Nowosad/raceland/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="raceland-intro3_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>raceland: Describing local pattern of racial landscape using SocScape grids</h1>
                        <h4 data-toc-skip class="author">Anna Dmowska, Tomasz Stepinski, Jakub Nowosad</h4>
            
            <h4 data-toc-skip class="date">2022-02-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Nowosad/raceland/blob/HEAD/vignettes/raceland-intro3.Rmd" class="external-link"><code>vignettes/raceland-intro3.Rmd</code></a></small>
      <div class="hidden name"><code>raceland-intro3.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">INTRODUCTION<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>raceland</strong> package implements a computational framework for a pattern-based, zoneless analysis and visualization of (ethno)racial topography. It is a reimagined approach for analyzing residential segregation and racial diversity based on the concept of ‘landscape’ used in the domain of landscape ecology. An overview of the implemented method is presented in the first vignette. Here we demonstrate, how the <strong>raceland</strong> package can be used for describing racial landscape at different spatial scales.</p>
<p>Here we demonstrate, how to use the implemented method with SocScape race-specific grids to perform analysis for different spatial scales. We use Cook county data as an example.</p>
</div>
<div class="section level2">
<h2 id="input-data">INPUT DATA<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h2>
<p>SocScape project provides a high resolution (30m) grids for each county in the conterminous U.S. and 351 MSA for 1990, 2000 and 2010. Data are organized as zip archives with three directories:</p>
<ol style="list-style-type: decimal">
<li>
<strong>population</strong> - contains population grids for each year (4 grids)</li>
<li>
<strong>diversity</strong> - contains racial diversity classification grids for each year (4 grids)</li>
<li>
<strong>race</strong> - contains separate grids for seven race/ethnicity groups for each year (27 grids)</li>
</ol>
<p>These grids have been calculated from the U.S. Census block-level data using dasymetric modeling with land cover as an auxiliary variable. Data is available at <a href="http://www.socscape.edu.pl/index.php?id=high-resolution-grids/" class="external-link uri">http://www.socscape.edu.pl/index.php?id=high-resolution-grids/</a>.</p>
</div>
<div class="section level2">
<h2 id="a-computational-framework">A COMPUTATIONAL FRAMEWORK<a class="anchor" aria-label="anchor" href="#a-computational-framework"></a>
</h2>
<p>A few steps are required to perform analysis based on the SocScape grids:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Download data</strong>: to download data, go to the website <a href="http://www.socscape.edu.pl/index.php?id=high-resolution-grids/" class="external-link uri">http://www.socscape.edu.pl/index.php?id=high-resolution-grids/</a>. For example, select state: Illinois; select county: Cook. The <em>il_cook.zip</em> file will be downloaded.</p></li>
<li><p><strong>Unzip the archive</strong> with the high-resolution grids.</p></li>
<li>
<p><strong>Use presented below script to fully automate analysis</strong>. The script requires to define a few arguments (see example below):</p>
<ul>
<li>a path to working directory</li>
<li>a path to <em>race</em> directory in unzipped data.</li>
<li>sfx - defines what datasets will be used(‘1990myc’ - a hi-res grids for 1990; ‘2000myc’ - a hi-res grids for 2000; ‘2010myc’ - a hi-res grids for 2010)</li>
<li>number of realization to calulate (i.e <code>nrealization = 100</code>)</li>
<li>size and shift arguments use to calculate IT-metrics for different spatial scale. It is a list of vectors in which the first element of the vector defines the size and the second the shift.</li>
</ul>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="results">RESULTS<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>Script creates a <em>results</em> directory with four subdirectories:</p>
<ul>
<li>
<p><strong>final</strong> - contains final results:</p>
<ul>
<li>complete_smr.csv - files with entropy and mutual information for different spatial scales</li>
<li>figures with maps for different scales: racial segregation (segregation_[size]<em>[shift].png), racial diversity (diversity</em>[size]<em>[shift].png) and segregation/diversity classification (bivar</em>[size]_[shift].png)</li>
</ul>
</li>
<li>
<p><strong>out_data</strong> - contains three files in the *.rds format:</p>
<ul>
<li>race_raster.rds - RasterStack with race-specific grids read from GeoTiffs files</li>
<li>real_rast.rds - RasterStack with realizations</li>
<li>dens_rast.rds - RasterStack with local densities</li>
</ul>
</li>
<li><p><strong>out_metrics</strong> - IT-metrics calculated for each defined spatial scale</p></li>
<li><p><strong>shp</strong> - contains shapefiles with attribute tables for each defined spatial scale. Shapefiles can be used to prepare maps</p></li>
</ul>
<table class="table">
<caption>Table 1: Entropy and mutual information for different spatial scales</caption>
<thead><tr class="header">
<th align="left">size</th>
<th align="left">shift</th>
<th align="right">n</th>
<th align="right">ent</th>
<th align="right">ent_sd</th>
<th align="right">mutinf</th>
<th align="right">mutinf_sd</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">60</td>
<td align="left">30</td>
<td align="right">2245</td>
<td align="right">1.0468</td>
<td align="right">0.0166</td>
<td align="right">0.0422</td>
<td align="right">0.0051</td>
</tr>
<tr class="even">
<td align="left">120</td>
<td align="left">60</td>
<td align="right">584</td>
<td align="right">1.1331</td>
<td align="right">0.0087</td>
<td align="right">0.0759</td>
<td align="right">0.0036</td>
</tr>
<tr class="odd">
<td align="left">240</td>
<td align="left">120</td>
<td align="right">145</td>
<td align="right">1.2951</td>
<td align="right">0.0043</td>
<td align="right">0.1432</td>
<td align="right">0.0027</td>
</tr>
<tr class="even">
<td align="left">480</td>
<td align="left">240</td>
<td align="right">37</td>
<td align="right">1.4403</td>
<td align="right">0.0023</td>
<td align="right">0.2229</td>
<td align="right">0.0019</td>
</tr>
<tr class="odd">
<td align="left">ALL</td>
<td align="left">ALL</td>
<td align="right">1</td>
<td align="right">1.8393</td>
<td align="right">0.0006</td>
<td align="right">0.4732</td>
<td align="right">0.0009</td>
</tr>
</tbody>
</table>
<div class="figure">
<img src="racial_landscape.png" alt="Figure 1: Racial landscape" width="40%"><p class="caption">
Figure 1: Racial landscape
</p>
</div>
<div class="figure">
<img src="div_seg.png" alt="Figure 2: Racial diversity and segregation at different spatial scales (an example for the scale of 1.8 km)" width="100%"><p class="caption">
Figure 2: Racial diversity and segregation at different spatial scales (an example for the scale of 1.8 km)
</p>
</div>
</div>
<div class="section level2">
<h2 id="script-to-calculate-the-it-derived-metrics-for-different-spatial-scales">SCRIPT TO CALCULATE THE IT-DERIVED METRICS FOR DIFFERENT SPATIAL SCALES<a class="anchor" aria-label="anchor" href="#script-to-calculate-the-it-derived-metrics-for-different-spatial-scales"></a>
</h2>
<p><em>Note: This calculation could take several minutes for larger counties.</em></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># R script calculates IT-derived metrices for different spatial scales. </span>

<span class="co"># INSTALL REQUIRED PACKAGES </span>
<span class="va">pkgs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="st">"raceland"</span>,                
  <span class="st">"comat"</span>,            
  <span class="st">"rgdal"</span>,   
  <span class="st">"raster"</span>,
  <span class="st">"sf"</span>,              
  <span class="st">"dplyr"</span>,
  <span class="st">"RColorBrewer"</span>
<span class="op">)</span>
<span class="va">to_install</span> <span class="op">=</span> <span class="op">!</span><span class="va">pkgs</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html" class="external-link">installed.packages</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">to_install</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">pkgs</span><span class="op">[</span><span class="va">to_install</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># REQUIRED R-PACKAGES</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/raceland/" class="external-link">raceland</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span>

<span class="co"># SET WORKING DIRECTORY</span>
<span class="co">## setwd("")</span>

<span class="co">################################## USER DEFINED PARAMETERS #######################################</span>
<span class="co"># Please define following parameters before running a script. </span>

<span class="co"># Path to race directory with downloaded data.</span>
<span class="va">pf_to_data</span> <span class="op">=</span> <span class="st">"il_cook/race"</span>

<span class="co"># sfx indicates which dataset will be used. There are 3 options: </span>
<span class="co">## sfx="1990myc" - race specific grids for 1990 year.</span>
<span class="co">## sfx="2000myc" - race specific grids for 2000 year.</span>
<span class="co">## sfx="2010myc" - race specific grids for 2010 year.</span>

<span class="va">sfx</span> <span class="op">=</span> <span class="st">"2010myc"</span>

<span class="co"># Number of realizations (racial landscape) to generate.</span>
<span class="co"># It is recommended to generate at least 30 realizations. </span>
<span class="va">nrealization</span> <span class="op">=</span> <span class="fl">100</span>

<span class="co"># list with size and shift parameters: list(c(size, shift), c(size, shift),...). </span>
<span class="co"># In this case calculation will be performed for 4 different spatia scale:</span>
<span class="co"># 1. c(60,30) - size = 60 local ladnscape from 60x60 cells window will be calculated, </span>
<span class="co">#    it corresponds to the spatial scale of 1.8km (60 cells x 30m).</span>
<span class="co"># 2. c(120,60) - corresponds to the scale of 3.6 km. </span>
<span class="co"># 3. c(240,120) - corresponds to the scale of 7.2 km. </span>
<span class="co"># 4. c(480, 240) - corresponds to the scale of 14.4 km. </span>
<span class="va">list_size_shift</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60</span>,<span class="fl">30</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">120</span>,<span class="fl">60</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">240</span>,<span class="fl">120</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">480</span>, <span class="fl">240</span><span class="op">)</span><span class="op">)</span>

<span class="co">####################################################################################################</span>

<span class="co"># FUNCTION TO CALCULATE RACIAL SEGREGATION/DIVERSITY CLASSIFICATION</span>
<span class="va">bivariate_classification</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">entropy</span>, <span class="va">mutual_information</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># max entropy is calculated as log2 from the number of race categories</span>
  <span class="va">nent</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
  
  <span class="co"># divide entropy values into 3 categories</span>
  <span class="va">ent_cat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">entropy</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.66</span>, <span class="fl">1.33</span>, <span class="va">nent</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, 
                include.lowest <span class="op">=</span> <span class="cn">TRUE</span>, right <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">ent_cat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ent_cat</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># divide mutual information values into 3 categories</span>
  <span class="va">mut_cat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">mutual_information</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span>, <span class="fl">0.66</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span>, 
                include.lowest <span class="op">=</span> <span class="cn">TRUE</span>, right <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">mut_cat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">mut_cat</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># combine categories of entropy (measure of racial diversity) </span>
  <span class="co"># and mutual information (measure of racial segregation) </span>
  <span class="va">bivar_cls</span> <span class="op">=</span> <span class="va">mut_cat</span> <span class="op">+</span> <span class="va">ent_cat</span>
  <span class="va">bivar_cls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">bivar_cls</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">bivar_cls</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">####################################################################################################</span>

<span class="co"># COLORS USED FOR VISUALIZATION</span>
<span class="co">## They corresponds to 5 racial categories: ASIAN, BLACK, HISPANIC, OTHER, WHITE</span>
<span class="va">race_colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#F16667"</span>, <span class="st">"#6EBE44"</span>, <span class="st">"#7E69AF"</span>, <span class="st">"#C77213"</span>, <span class="st">"#F8DF1D"</span><span class="op">)</span>

<span class="co">## Bivariate palette to display the racial segregation/diversity classification</span>
<span class="va">bivariate_class_colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"11"</span> <span class="op">=</span> <span class="st">"#e8e8e8"</span>, <span class="st">"12"</span> <span class="op">=</span> <span class="st">"#e4acac"</span>, <span class="st">"13"</span> <span class="op">=</span> <span class="st">"#c85a5a"</span>,
                           <span class="st">"21"</span> <span class="op">=</span> <span class="st">"#b0d5df"</span>, <span class="st">"22"</span> <span class="op">=</span> <span class="st">"#ad9ea5"</span>, <span class="st">"23"</span> <span class="op">=</span> <span class="st">"#985356"</span>,
                           <span class="st">"31"</span> <span class="op">=</span> <span class="st">"#64acbe"</span>, <span class="st">"32"</span> <span class="op">=</span> <span class="st">"#627f8c"</span>, <span class="st">"33"</span> <span class="op">=</span> <span class="st">"#574249"</span><span class="op">)</span>

<span class="co">####################################################################################################</span>

<span class="co">################################## CREATE RESULTS DIRECTORY WITH SUBDIRECTORIES ####################</span>
<span class="co"># results directory will be created as subdirectory in working directory</span>
<span class="va">pf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"out_data"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"out_metrics"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"final"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"shp"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">###################################################################################################</span>

<span class="co">################################## PREPROCESS RACE-SPECIFIC DATA ##################################</span>
<span class="co"># Read data from GeoTIFFs to a RasterStack object</span>
<span class="va">list_raster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">pf_to_data</span>, pattern <span class="op">=</span> <span class="va">sfx</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">race_raster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="va">list_raster</span><span class="op">)</span>

<span class="co"># Rename raster layers</span>
<span class="va">rnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">race_raster</span><span class="op">)</span>, <span class="st">"_"</span><span class="op">)</span>, <span class="va">tail</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">rnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">rnames</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">rnames</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">sfx</span><span class="op">)</span><span class="op">)</span>

<span class="va">new_names</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span>
  <span class="va">rnames</span>,
  <span class="st">"hispanic"</span> <span class="op">=</span> <span class="st">"hispanic"</span>,
  <span class="st">"nham"</span> <span class="op">=</span> <span class="st">"am"</span>,
  <span class="st">"nhas"</span> <span class="op">=</span> <span class="st">"asian"</span>,
  <span class="st">"nhb"</span> <span class="op">=</span> <span class="st">"black"</span>,
  <span class="st">"nhother"</span> <span class="op">=</span> <span class="st">"other"</span>,
  <span class="st">"nhpi"</span> <span class="op">=</span> <span class="st">"pi"</span>,
  <span class="st">"nhw"</span> <span class="op">=</span> <span class="st">"white"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">race_raster</span><span class="op">)</span> <span class="op">=</span> <span class="va">new_names</span>

<span class="co"># Reorder layers in RasterStack</span>
<span class="va">race_raster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">race_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"asian"</span>, <span class="st">"am"</span>, <span class="st">"black"</span>, <span class="st">"hispanic"</span>, <span class="st">"other"</span>, <span class="st">"pi"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Combine race-specific categories (ASIAN=ASIAN+PI, OTHER=OTHER+AM). </span>
<span class="co"># Please notice that pi category does not exist for 1990myc dataset.</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">sfx</span> <span class="op">==</span> <span class="st">"1990myc"</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">race_raster</span><span class="op">[[</span><span class="st">"other"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">race_raster</span><span class="op">[[</span><span class="st">"other"</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">race_raster</span><span class="op">[[</span><span class="st">"am"</span><span class="op">]</span><span class="op">]</span>
  <span class="va">race_raster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/addLayer.html" class="external-link">dropLayer</a></span><span class="op">(</span><span class="va">race_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"am"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">race_raster</span><span class="op">[[</span><span class="st">"other"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">race_raster</span><span class="op">[[</span><span class="st">"other"</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">race_raster</span><span class="op">[[</span><span class="st">"am"</span><span class="op">]</span><span class="op">]</span>
  <span class="va">race_raster</span><span class="op">[[</span><span class="st">"asian"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">race_raster</span><span class="op">[[</span><span class="st">"asian"</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">race_raster</span><span class="op">[[</span><span class="st">"pi"</span><span class="op">]</span><span class="op">]</span>
  <span class="va">race_raster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/addLayer.html" class="external-link">dropLayer</a></span><span class="op">(</span><span class="va">race_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"am"</span>, <span class="st">"pi"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># race raster object contains 5 layers: </span>
<span class="co"># asian, black, hispanic, other, white with subpolulation densities</span>
<span class="va">race_raster</span>

<span class="co"># save race_raster to a rds file</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">race_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"out_data"</span>, <span class="st">"race_raster.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="co">###################################################################################################</span>

<span class="co">################################## CONSTRUCTING RACIAL LANDSCAPE ##################################</span>
<span class="va">real_raster</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_realizations.html">create_realizations</a></span><span class="op">(</span><span class="va">race_raster</span>, n <span class="op">=</span> <span class="va">nrealization</span><span class="op">)</span>

<span class="co"># save real_raster object</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">real_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"out_data"</span>, <span class="st">"real_rast.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># plot racial landscape</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"final"</span>, <span class="st">"racial_landscape.png"</span><span class="op">)</span><span class="op">)</span> 
<span class="fu"><a href="../reference/plot_realization.html">plot_realization</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">real_raster</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">race_raster</span>, hex <span class="op">=</span> <span class="va">race_colors</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> 
<span class="co">###################################################################################################</span>

<span class="co">################################## CALCULATE RACE-SPECIFIC DENSTITIES #############################</span>
<span class="va">dens_raster</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_densities.html">create_densities</a></span><span class="op">(</span><span class="va">real_raster</span>, <span class="va">race_raster</span>, window_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="co"># save dens_raster object</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">dens_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"results"</span>, <span class="st">"out_data"</span>, <span class="st">"dens_rast.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="co">###################################################################################################</span>

<span class="co">################################## CALCULATE METRICS FOR DIFFERENT SPATIAL SCALES ################</span>

<span class="va">complete_smr_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">list_size_shift</span><span class="op">)</span> <span class="op">{</span> <span class="co">#start size loop</span>
  <span class="va">size</span> <span class="op">=</span> <span class="va">i</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">shift</span> <span class="op">=</span> <span class="va">i</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  
  <span class="co">#######################CALCULATE METRICS FOR SPECIFIED SIZE/SHIFT PARAMETER######################</span>
  <span class="va">metr_df</span> <span class="op">=</span> <span class="fu"><a href="../reference/calculate_metrics.html">calculate_metrics</a></span><span class="op">(</span><span class="va">real_raster</span>, <span class="va">dens_raster</span>,
                              neighbourhood <span class="op">=</span> <span class="fl">4</span>, fun <span class="op">=</span> <span class="st">"mean"</span>,
                              size <span class="op">=</span> <span class="va">size</span>, shift <span class="op">=</span> <span class="va">shift</span>, threshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
  
  <span class="co"># Summarize metrics</span>
  <span class="co">## Number of motifels at given spatial scale</span>
  <span class="va">sel</span> <span class="op">=</span> <span class="va">metr_df</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">metr_df</span><span class="op">$</span><span class="va">ent</span><span class="op">)</span>, <span class="op">]</span>
  <span class="va">nmotif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">sel</span><span class="op">$</span><span class="va">realization</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Metrics summary</span>
  <span class="va">smr</span> <span class="op">=</span> <span class="va">metr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">row</span>, <span class="va">col</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>
      ent_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ent</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
      ent_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">ent</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
      mutinf_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mutinf</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
      mutinf_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mutinf</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
  
  <span class="va">smr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">smr</span><span class="op">)</span>

  <span class="co"># Calculate an ensemble average for entropy and mutual information</span>
  <span class="va">complete_smr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
    size <span class="op">=</span> <span class="va">size</span>,
    shift <span class="op">=</span> <span class="va">shift</span>,
    n <span class="op">=</span> <span class="va">nmotif</span>,
    ent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smr</span><span class="op">$</span><span class="va">ent_mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    ent_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smr</span><span class="op">$</span><span class="va">ent_sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    mutinf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smr</span><span class="op">$</span><span class="va">mutinf_mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    mutinf_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smr</span><span class="op">$</span><span class="va">mutinf_sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="va">complete_smr_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">complete_smr_df</span>, <span class="va">complete_smr</span><span class="op">)</span>
  
  <span class="co"># Calculate racial segregation/diversity classification</span>
  <span class="va">smr</span><span class="op">$</span><span class="va">bivar_cls</span> <span class="op">=</span> <span class="fu">bivariate_classification</span><span class="op">(</span>entropy <span class="op">=</span> <span class="va">smr</span><span class="op">$</span><span class="va">ent_mean</span>, 
                                           mutual_information <span class="op">=</span> <span class="va">smr</span><span class="op">$</span><span class="va">mutinf_mean</span>,
                                           n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/nlayers.html" class="external-link">nlayers</a></span><span class="op">(</span><span class="va">race_raster</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Save the metrics to csv</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">metr_df</span>, 
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"out_metrics"</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"metr_df_"</span>, <span class="va">size</span>, <span class="st">"_"</span>, <span class="va">shift</span>, <span class="st">".csv"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>,
            row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">smr</span>, 
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"out_metrics"</span>, 
                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"smr_metr_df_"</span>, <span class="va">size</span>, <span class="st">"_"</span>, <span class="va">shift</span>, <span class="st">".csv"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>,
            row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  
  
  <span class="co">#######################CREATE SPATIAL OBJECT WITG METRICES######################</span>
  
  <span class="co"># Create spatial object</span>
  <span class="va">grid_sf</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_grid.html">create_grid</a></span><span class="op">(</span><span class="va">real_raster</span>, size <span class="op">=</span> <span class="va">size</span>, shift <span class="op">=</span> <span class="va">shift</span><span class="op">)</span>
  
  <span class="co"># Join metrics to the grid</span>
  <span class="va">attr_grid</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">grid_sf</span>, <span class="va">smr</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="st">"col"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">sel_grid</span> <span class="op">=</span> <span class="va">attr_grid</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">attr_grid</span><span class="op">$</span><span class="va">ent_mean</span><span class="op">)</span>,<span class="op">]</span>
  
  <span class="co"># Save the grid as shapefile</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">attr_grid</span>, 
           <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"shp"</span>, 
                     <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"metr_stat_"</span>, <span class="va">size</span>, <span class="st">"_"</span>, <span class="va">shift</span>, <span class="st">".shp"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">#######################VISUALIZATION#########################################</span>
  
  <span class="co"># Divide entropy values into 10 class</span>
  <span class="va">ent_breaks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, by <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/nlayers.html" class="external-link">nlayers</a></span><span class="op">(</span><span class="va">race_raster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Divide mutual information into 10 class</span>
  <span class="va">mut_breaks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
  
  <span class="co"># Spatial scale in km</span>
  <span class="va">scale_km</span> <span class="op">=</span> <span class="op">(</span><span class="va">shift</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/resolution.html" class="external-link">res</a></span><span class="op">(</span><span class="va">race_raster</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span>
  
  <span class="co"># Mapping racial diversity (save plot to .png)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"final"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"diversity_"</span>, <span class="va">size</span>, <span class="st">"_"</span>, <span class="va">shift</span>, <span class="st">".png"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sel_grid</span><span class="op">[</span><span class="st">"ent_mean"</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="va">ent_breaks</span>, key.pos <span class="op">=</span> <span class="fl">1</span>,
       pal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ent_breaks</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"RdBu"</span><span class="op">)</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span>, 
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Racial diversity (Entropy) at the scale of "</span>, 
                    <span class="va">scale_km</span>, <span class="st">" km"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> 
  
  <span class="co"># Mapping racial segregation (save plot to .png)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"final"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"segregation_"</span>, <span class="va">size</span>, <span class="st">"_"</span>, <span class="va">shift</span>, <span class="st">".png"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sel_grid</span><span class="op">[</span><span class="st">"mutinf_mean"</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="va">mut_breaks</span>, key.pos <span class="op">=</span> <span class="fl">1</span>, 
       pal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mut_breaks</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"RdBu"</span><span class="op">)</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span>, 
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Racial segregation (Mutual information) at the scale of "</span>,
                    <span class="va">scale_km</span>, <span class="st">" km"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> 
  
  <span class="co"># Mapping racial segregation/diversity (save plot to .png)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"final"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"bivar_"</span>, <span class="va">size</span>, <span class="st">"_"</span>, <span class="va">shift</span>, <span class="st">".png"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>   
  <span class="va">bcat</span> <span class="op">=</span> <span class="va">bivariate_class_colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bivariate_class_colors</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">sel_grid</span><span class="op">$</span><span class="va">bivar_cls</span><span class="op">)</span><span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sel_grid</span><span class="op">[</span><span class="st">"bivar_cls"</span><span class="op">]</span>, 
       pal <span class="op">=</span> <span class="va">bcat</span>,
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Racial diversity/segregation classification at the scale of "</span>,
                     <span class="va">scale_km</span>, <span class="st">" km"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> 
<span class="op">}</span> <span class="co">#stop size loop</span>


<span class="co">###################################################################################################</span>

<span class="co">################################## CALCULATE METRICS FOR THE WHOLE RACIAL LANDSCAPE ###############</span>

<span class="va">metr</span> <span class="op">=</span> <span class="fu"><a href="../reference/calculate_metrics.html">calculate_metrics</a></span><span class="op">(</span><span class="va">real_raster</span>, <span class="va">dens_raster</span>,
                         neighbourhood <span class="op">=</span> <span class="fl">4</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, 
                         size <span class="op">=</span> <span class="cn">NULL</span>, threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">complete_smr_all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  size <span class="op">=</span> <span class="st">"ALL"</span>,
  shift <span class="op">=</span> <span class="st">"ALL"</span>,
  n <span class="op">=</span> <span class="fl">1</span>,
  ent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">metr</span><span class="op">$</span><span class="va">ent</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  ent_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">metr</span><span class="op">$</span><span class="va">ent</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  mutinf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">metr</span><span class="op">$</span><span class="va">mutinf</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  mutinf_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">metr</span><span class="op">$</span><span class="va">mutinf</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">complete_smr_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">complete_smr_df</span>, <span class="va">complete_smr_all</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">complete_smr_df</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"size"</span>, <span class="st">"shift"</span>, <span class="st">"n"</span>, <span class="st">"ent"</span>, <span class="st">"ent_sd"</span>, <span class="st">"mutinf"</span>, <span class="st">"mutinf_sd"</span><span class="op">)</span>

<span class="co"># Write table with metrices for different spatial scales and for the whole area. </span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">complete_smr_df</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"results"</span>, <span class="st">"final"</span>, <span class="st">"complete_smr.csv"</span><span class="op">)</span>,
          row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">###################################################################################################</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jakub Nowosad, Anna Dmowska, Tomasz Stepinski.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
